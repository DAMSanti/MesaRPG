<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MesaRPG - Panel de Admin</title>
    <link rel="icon" type="image/png" href="/mobile/assets/icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/admin/css/admin.css">
</head>
<body>
    <div id="connection-status" class="disconnected">Desconectado</div>
    
    <div class="container">
        <header class="header">
            <h1>ğŸ® MesaRPG - Panel de Control</h1>
            <div id="game-system-selector" class="system-selector">
                <label>Sistema de Juego:</label>
                <select id="system-select" onchange="setGameSystem(this.value)">
                    <option value="">Cargando...</option>
                </select>
                <span id="current-system-display" class="current-system-display" style="display: none;"></span>
                <button id="btn-change-system" class="btn btn-warning btn-sm" style="display: none;" onclick="confirmChangeSystem()">
                    ğŸ”„ Cambiar Juego
                </button>
            </div>
        </header>

        <!-- Tabs de navegaciÃ³n -->
        <nav class="tabs">
            <button class="tab active" data-tab="game">ğŸ² Partida</button>
            <button class="tab" data-tab="maps">ğŸ—ºï¸ Mapas</button>
            <button class="tab" data-tab="camera">ğŸ“· CÃ¡mara</button>
            <button class="tab" data-tab="sheets">ğŸ“‹ Fichas</button>
            <button class="tab" data-tab="tokens">ğŸ¯ Tokens</button>
            <button class="tab" data-tab="combat">âš”ï¸ Combate</button>
        </nav>

        <!-- Tab: Partida -->
        <section id="tab-game" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h2>ğŸ“¡ Estado de Conexiones</h2>
                    <div class="status-grid">
                        <div class="status-item">
                            <span class="status-label">Pantallas</span>
                            <span id="display-count" class="status-value">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">MÃ³viles</span>
                            <span id="mobile-count" class="status-value">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">CÃ¡mara</span>
                            <span id="camera-status" class="status-value">âŒ</span>
                        </div>
                    </div>
                    <div id="player-list-container" class="player-list">
                        <h3>Jugadores Conectados</h3>
                        <div id="player-list">Ninguno</div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ‘¥ Personajes en Juego</h2>
                    <div id="active-characters" class="character-list">
                        <p class="empty-state">No hay personajes en juego</p>
                    </div>
                </div>

                <div class="card full-width">
                    <h2>ğŸ“œ Log de Acciones</h2>
                    <div id="action-log" class="log"></div>
                </div>
            </div>
        </section>

        <!-- Tab: Editor de Mapas -->
        <section id="tab-maps" class="tab-content">
            <div class="map-editor-container">
                <!-- Barra de herramientas -->
                <div class="map-toolbar">
                    <div class="toolbar-group">
                        <button class="btn btn-sm" onclick="showNewMapDialog()">ğŸ“„ Nuevo</button>
                        <button class="btn btn-sm" onclick="mapEditor?.saveMap()">ğŸ’¾ Guardar</button>
                        <button class="btn btn-sm" onclick="showLoadMapDialog()">ğŸ“‚ Cargar</button>
                        <button class="btn btn-sm" onclick="mapEditor?.exportMap()">ğŸ“¤ Exportar</button>
                        <label class="btn btn-sm">
                            ğŸ“¥ Importar
                            <input type="file" accept=".json" style="display:none" onchange="mapEditor?.importMap(this.files[0])">
                        </label>
                    </div>
                    <div class="toolbar-group">
                        <button class="tool-btn active" data-tool="paint" onclick="mapEditor?.setTool('paint')" title="Pintar (P)">ğŸ–Œï¸</button>
                        <button class="tool-btn" data-tool="erase" onclick="mapEditor?.setTool('erase')" title="Borrar (E)">ğŸ§¹</button>
                        <button class="tool-btn" data-tool="fill" onclick="mapEditor?.setTool('fill')" title="Rellenar (F)">ğŸª£</button>
                        <button class="tool-btn" data-tool="eyedropper" onclick="mapEditor?.setTool('eyedropper')" title="Cuentagotas (I)">ğŸ’‰</button>
                    </div>
                    <div class="toolbar-group">
                        <label>Pincel:</label>
                        <input type="range" min="1" max="5" value="1" onchange="mapEditor?.setBrushSize(this.value)">
                        <span id="brush-size-value">1</span>
                    </div>
                    <div class="toolbar-group">
                        <button class="btn btn-sm" onclick="mapEditor?.undo()" title="Deshacer (Ctrl+Z)">â†©ï¸</button>
                        <button class="btn btn-sm" onclick="mapEditor?.redo()" title="Rehacer (Ctrl+Y)">â†ªï¸</button>
                    </div>
                    <div class="toolbar-group">
                        <label>
                            <input type="checkbox" id="show-hex-borders" onchange="mapEditor?.setShowHexBorders(this.checked)">
                            Bordes
                        </label>
                    </div>
                    <div class="toolbar-group">
                        <button class="btn btn-sm btn-success" onclick="mapEditor?.projectToDisplay()">ğŸ“º Proyectar</button>
                    </div>
                </div>

                <div class="map-editor-main">
                    <!-- Panel de tiles (izquierda) -->
                    <div class="tile-panel">
                        <h3>ğŸ¨ Tiles</h3>
                        <div class="layer-selector">
                            <button class="layer-btn active" data-layer="terrain" onclick="mapEditor?.setLayer('terrain')">Terreno</button>
                            <button class="layer-btn" data-layer="objects" onclick="mapEditor?.setLayer('objects')">Objetos</button>
                            <button class="layer-btn" data-layer="effects" onclick="mapEditor?.setLayer('effects')">Efectos</button>
                        </div>
                        <div id="tile-palette" class="tile-palette">
                            <!-- Tiles se cargan dinÃ¡micamente -->
                        </div>
                        <div id="tile-info" class="tile-info">
                            <p>Selecciona un tile</p>
                        </div>
                    </div>

                    <!-- Canvas del mapa (centro) -->
                    <div class="map-canvas-container">
                        <canvas id="map-canvas"></canvas>
                    </div>

                    <!-- Panel de propiedades (derecha) -->
                    <div class="properties-panel">
                        <h3>âš™ï¸ Propiedades del Mapa</h3>
                        <div class="property-group">
                            <label>Nombre:</label>
                            <input type="text" id="map-name" placeholder="Nombre del mapa">
                        </div>
                        <div class="property-group">
                            <label>TamaÃ±o:</label>
                            <span id="map-size">20 x 15</span>
                        </div>
                        
                        <h3>ğŸ² GeneraciÃ³n Procedural</h3>
                        <div class="property-group">
                            <label>Ancho:</label>
                            <input type="number" id="gen-width" value="20" min="10" max="50">
                        </div>
                        <div class="property-group">
                            <label>Alto:</label>
                            <input type="number" id="gen-height" value="15" min="10" max="50">
                        </div>
                        <div class="property-group">
                            <label>Tipo:</label>
                            <select id="gen-type">
                                <!-- Se rellena dinÃ¡micamente segÃºn el sistema -->
                            </select>
                        </div>
                        <button class="btn btn-primary full-width" onclick="generateMap()">ğŸ² Generar Mapa</button>

                        <h3>ğŸ—‚ï¸ Mapas Guardados</h3>
                        <div id="saved-maps-list" class="saved-maps-list">
                            <p class="empty-state">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab: CÃ¡mara y Tracking -->
        <section id="tab-camera" class="tab-content">
            <div class="camera-controls-bar">
                <div class="camera-local">
                    <label>ğŸ“¹ CÃ¡mara local:</label>
                    <select id="camera-select">
                        <option value="">Cargando cÃ¡maras...</option>
                    </select>
                    <button class="btn btn-primary" id="btn-connect-camera">ğŸ”— Conectar</button>
                </div>
                <div class="camera-ip">
                    <label>ğŸŒ CÃ¡mara IP:</label>
                    <input type="text" id="camera-ip-input" placeholder="192.168.1.55:4747">
                    <button class="btn btn-primary" id="btn-connect-ip">ğŸ”— Conectar IP</button>
                </div>
                <button class="btn btn-danger" id="btn-disconnect-camera" disabled>â¹ï¸ Desconectar</button>
                <div class="camera-status-inline">
                    <span id="camera-state" class="camera-state disconnected">ğŸ”´ Desconectado</span>
                    <span id="camera-fps">-</span> FPS |
                    <span id="detections-count">0</span> detecciones
                </div>
            </div>
            
            <div class="dual-feed-container">
                <!-- Feed LOCAL (directo de la cÃ¡mara) -->
                <div class="feed-panel">
                    <h3>ğŸ“¹ CÃ¡mara Local / IP</h3>
                    <div class="feed-wrapper">
                        <video id="local-video" autoplay playsinline muted></video>
                        <img id="ip-video" style="display:none;">
                        <div id="local-overlay" class="feed-overlay">
                            <p>ğŸ“· Selecciona una cÃ¡mara o introduce IP</p>
                        </div>
                    </div>
                </div>
                
                <!-- Feed PROCESADO (del servidor con YOLO) -->
                <div class="feed-panel">
                    <h3>ğŸ¤– Procesado (YOLO)</h3>
                    <div class="feed-wrapper">
                        <img id="camera-feed" alt="Feed procesado">
                        <div id="processed-overlay" class="feed-overlay">
                            <p>â³ Esperando frames procesados...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="camera-settings-bar">
                <div class="setting-item">
                    <label>Calidad:</label>
                    <input type="range" id="stream-quality" min="30" max="100" value="70">
                    <span>70%</span>
                </div>
                <div class="setting-item">
                    <label>FPS:</label>
                    <input type="range" id="stream-fps" min="5" max="30" value="10">
                    <span>10</span>
                </div>
            </div>
        </section>

        <!-- Tab: Fichas de Personaje -->
        <section id="tab-sheets" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>â³ Fichas Pendientes de AprobaciÃ³n</h2>
                    <div id="pending-sheets" class="sheet-list">
                        <p class="empty-state">No hay fichas pendientes</p>
                    </div>
                </div>

                <div class="card">
                    <h2>âœ… Fichas Aprobadas</h2>
                    <div id="approved-sheets" class="sheet-list">
                        <p class="empty-state">No hay fichas aprobadas</p>
                    </div>
                </div>
            </div>

            <!-- Modal para ver/editar ficha -->
            <div id="sheet-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="sheet-modal-title">Ficha de Personaje</h2>
                        <button class="close-btn" onclick="closeSheetModal()">Ã—</button>
                    </div>
                    <div id="sheet-modal-body" class="modal-body">
                        <!-- Contenido dinÃ¡mico -->
                    </div>
                    <div class="modal-footer" id="sheet-modal-footer">
                        <!-- Botones dinÃ¡micos -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab: AsignaciÃ³n de Tokens -->
        <section id="tab-tokens" class="tab-content">
            <div class="grid">
                <!-- Nueva secciÃ³n: Figuritas detectadas por cÃ¡mara -->
                <div class="card full-width">
                    <h2>ğŸ“· Figuritas Detectadas (CÃ¡mara)</h2>
                    <p class="help-text">Haz clic en una figurita detectada y luego en un personaje para vincularlos.</p>
                    
                    <div class="detected-miniatures-section">
                        <div class="detected-list" id="detected-miniatures">
                            <p class="empty-state">No hay figuritas detectadas. Activa la cÃ¡mara para detectar.</p>
                        </div>
                    </div>
                    
                    <div class="assignment-actions" style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="refreshDetectedMiniatures()">ğŸ”„ Actualizar</button>
                        <button class="btn btn-warning" onclick="clearAllAssignments()">ğŸ—‘ï¸ Limpiar Asignaciones</button>
                    </div>
                </div>
                
                <!-- Personajes disponibles para asignar -->
                <div class="card full-width">
                    <h2>ğŸ‘¤ Personajes en Partida</h2>
                    <div id="characters-for-assignment" class="characters-assignment-grid">
                        <p class="empty-state">No hay personajes. Crea uno en la pestaÃ±a Fichas.</p>
                    </div>
                </div>

                <div class="card full-width">
                    <h2>ğŸ¯ Asignar Tokens Visuales</h2>
                    <p class="help-text">Selecciona un jugador y elige un token visual para representarlo en el tablero.</p>
                    
                    <div id="token-assignment" class="token-assignment-grid-simple">
                        <!-- Paso 1: Seleccionar ficha -->
                        <div class="assignment-step">
                            <h3>1. Selecciona una ficha</h3>
                            <div id="sheets-for-token" class="sheets-grid">
                                <p class="empty-state">No hay fichas pendientes de token</p>
                            </div>
                        </div>
                        
                        <!-- Paso 2: Seleccionar token visual -->
                        <div class="assignment-step">
                            <h3>2. Elige un token</h3>
                            <div class="token-category-tabs">
                                <button class="token-tab active" data-category="system">Sistema Actual</button>
                                <button class="token-tab" data-category="generic">GenÃ©ricos</button>
                            </div>
                            <div id="token-gallery" class="token-gallery">
                                <p class="empty-state">Selecciona una categorÃ­a</p>
                            </div>
                            <button class="btn btn-success btn-large" id="assign-token-btn" onclick="assignTokenVisual()" disabled>
                                âœ¨ Asignar Token
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card full-width">
                    <h2>ğŸ“‹ Tokens Asignados</h2>
                    <div id="assigned-tokens" class="assigned-tokens-grid">
                        <p class="empty-state">No hay tokens asignados</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab: Combate -->
        <section id="tab-combat" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>âš”ï¸ Control de Combate</h2>
                    <div class="combat-controls">
                        <button class="btn btn-success" onclick="startCombat()">â–¶ï¸ Iniciar Combate</button>
                        <button class="btn btn-danger" onclick="endCombat()">â¹ï¸ Finalizar Combate</button>
                        <button class="btn btn-primary" onclick="nextTurn()">â­ï¸ Siguiente Turno</button>
                    </div>
                    <div class="combat-status">
                        <div class="status-row">
                            <span>Estado:</span>
                            <span id="combat-state">Fuera de combate</span>
                        </div>
                        <div class="status-row">
                            <span>Turno:</span>
                            <span id="current-turn">-</span>
                        </div>
                        <div class="status-row">
                            <span>Personaje Activo:</span>
                            <span id="active-character">-</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“Š Orden de Iniciativa</h2>
                    <div id="initiative-order" class="initiative-list">
                        <p class="empty-state">No hay combate activo</p>
                    </div>
                </div>

                <div class="card full-width">
                    <h2>ğŸ§ª Herramientas de Debug</h2>
                    <div class="debug-tools">
                        <button class="btn" onclick="addTestCharacter()">+ AÃ±adir Personaje Test</button>
                        <button class="btn btn-danger" onclick="clearCharacters()">ğŸ—‘ï¸ Limpiar Personajes</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="/admin/js/admin.js"></script>
    <script src="/admin/js/camera-panel.js"></script>
    <script src="/admin/js/battletech-map-generator.js"></script>
    <script src="/admin/js/map-editor.js"></script>
</body>
</html>
