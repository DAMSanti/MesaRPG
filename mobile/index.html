<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>MesaRPG - Control</title>
    
    <link rel="manifest" href="/mobile/manifest.json">
    <link rel="icon" type="image/png" href="/mobile/assets/icon-192.png">
    <link rel="apple-touch-icon" href="/mobile/assets/icon-192.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/mobile/css/mobile.css">
</head>
<body>
    <div id="app">
        <!-- Pantalla de Login -->
        <section id="login-screen" class="screen active">
            <div class="login-container">
                <h1>üé≤ MesaRPG</h1>
                <p>Control de Jugador</p>
                
                <form id="login-form">
                    <input type="text" id="player-name" placeholder="Tu nombre" required maxlength="20">
                    <button type="submit" class="btn btn-primary">Entrar</button>
                </form>
                
                <div id="connection-error" class="error hidden">
                    No se pudo conectar al servidor
                </div>
            </div>
        </section>

        <!-- Pantalla: Esperando Sistema de Juego -->
        <section id="waiting-system-screen" class="screen">
            <div class="centered-content">
                <div class="spinner"></div>
                <h2>Esperando al Game Master</h2>
                <p>El GM debe seleccionar un sistema de juego</p>
                <p id="player-welcome" class="welcome-text"></p>
            </div>
        </section>

        <!-- Pantalla: Estado de Ficha -->
        <section id="sheet-status-screen" class="screen">
            <header class="mobile-header">
                <h2>üìã Tu Ficha</h2>
                <span id="sheet-game-system" class="badge"></span>
            </header>

            <div class="sheet-status-container">
                <!-- Sin ficha -->
                <div id="no-sheet-panel" class="status-panel">
                    <div class="status-icon">üìù</div>
                    <h3>Crea tu Personaje</h3>
                    <p>Elige c√≥mo quieres crear tu ficha:</p>
                    
                    <div class="sheet-options">
                        <button id="btn-create-manual" class="btn btn-large btn-primary">
                            <span class="btn-icon">‚úèÔ∏è</span>
                            <span class="btn-text">Crear Ficha</span>
                        </button>
                        
                        <button id="btn-scan-sheet" class="btn btn-large btn-secondary">
                            <span class="btn-icon">üì∑</span>
                            <span class="btn-text">Escanear Ficha</span>
                        </button>
                    </div>
                </div>

                <!-- Ficha en borrador -->
                <div id="draft-sheet-panel" class="status-panel hidden">
                    <div class="status-icon">üìù</div>
                    <h3>Ficha en Borrador</h3>
                    <p id="draft-char-name" class="char-name-display"></p>
                    <div class="action-buttons">
                        <button id="btn-edit-sheet" class="btn btn-primary">‚úèÔ∏è Editar</button>
                        <button id="btn-submit-sheet" class="btn btn-success">üì§ Enviar al GM</button>
                    </div>
                </div>

                <!-- Ficha pendiente -->
                <div id="pending-sheet-panel" class="status-panel hidden">
                    <div class="status-icon pending">‚è≥</div>
                    <h3>Pendiente de Aprobaci√≥n</h3>
                    <p id="pending-char-name" class="char-name-display"></p>
                    <p class="status-message">El Game Master est√° revisando tu ficha...</p>
                </div>

                <!-- Ficha rechazada -->
                <div id="rejected-sheet-panel" class="status-panel hidden">
                    <div class="status-icon rejected">‚ùå</div>
                    <h3>Ficha Rechazada</h3>
                    <p id="rejected-char-name" class="char-name-display"></p>
                    <p id="rejection-reason" class="rejection-reason"></p>
                    <button id="btn-fix-sheet" class="btn btn-primary">‚úèÔ∏è Corregir y Reenviar</button>
                </div>

                <!-- Ficha aprobada, esperando token -->
                <div id="approved-sheet-panel" class="status-panel hidden">
                    <div class="status-icon approved">‚úÖ</div>
                    <h3>¬°Ficha Aprobada!</h3>
                    <p id="approved-char-name" class="char-name-display"></p>
                    <p class="status-message">Esperando que el GM te asigne un token...</p>
                </div>

                <!-- En juego -->
                <div id="ingame-sheet-panel" class="status-panel hidden">
                    <div class="ingame-header">
                        <img id="assigned-token-image" class="token-display" src="" alt="Token">
                        <div class="ingame-info">
                            <h3 id="ingame-char-name" class="char-name-display"></h3>
                            <p class="token-name" id="assigned-token-name">Token asignado</p>
                        </div>
                    </div>
                    <button id="btn-go-control" class="btn btn-primary btn-large">‚öîÔ∏è Ir al Control</button>
                </div>
            </div>
        </section>

        <!-- Pantalla: Formulario de Ficha (Estilo D&D Paper) -->
        <section id="sheet-form-screen" class="screen">
            <header class="mobile-header">
                <button id="btn-back-from-form" class="btn-icon">‚Üê</button>
                <h2 id="form-title">Ficha de Personaje</h2>
                <button id="btn-save-draft" class="btn btn-sm">üíæ</button>
            </header>

            <form id="character-sheet-form" class="dnd-sheet">
                <!-- Header con logo y t√≠tulo -->
                <div class="sheet-header">
                    <div class="sheet-logo">üêâ</div>
                    <h1 class="sheet-title">FICHA DE PERSONAJE</h1>
                </div>

                <!-- Fila superior: Nombre, Clase, Nivel, Raza -->
                <div class="sheet-top-row">
                    <div class="field-box name-box">
                        <input type="text" id="field-name" name="name" required placeholder=" ">
                        <label>Nombre del Personaje</label>
                    </div>
                    <div class="field-box-group">
                        <div class="field-box small">
                            <select id="field-class" name="class" required>
                                <option value="">-</option>
                            </select>
                            <label>Clase</label>
                        </div>
                        <div class="field-box small">
                            <input type="number" id="field-level" name="level" min="1" max="20" value="1">
                            <label>Nivel</label>
                        </div>
                        <div class="field-box small">
                            <select id="field-race" name="race" required>
                                <option value="">-</option>
                            </select>
                            <label>Raza</label>
                        </div>
                    </div>
                </div>

                <!-- Segunda fila: Trasfondo, Alineamiento -->
                <div class="sheet-row">
                    <div class="field-box">
                        <input type="text" id="field-background" name="background" placeholder=" ">
                        <label>Trasfondo</label>
                    </div>
                    <div class="field-box">
                        <select id="field-alignment" name="alignment">
                            <option value="">-</option>
                        </select>
                        <label>Alineamiento</label>
                    </div>
                </div>

                <!-- √Årea principal: Atributos + Combate -->
                <div class="sheet-main">
                    <!-- Columna izquierda: Atributos -->
                    <div class="attributes-column">
                        <h3 class="section-title">ATRIBUTOS</h3>
                        <div class="attribute-box" data-attr="strength">
                            <span class="attr-name">FUE</span>
                            <input type="number" id="field-strength" name="strength" min="1" max="30" value="10" class="attr-value">
                            <span class="attr-modifier" id="mod-strength">+0</span>
                        </div>
                        <div class="attribute-box" data-attr="dexterity">
                            <span class="attr-name">DES</span>
                            <input type="number" id="field-dexterity" name="dexterity" min="1" max="30" value="10" class="attr-value">
                            <span class="attr-modifier" id="mod-dexterity">+0</span>
                        </div>
                        <div class="attribute-box" data-attr="constitution">
                            <span class="attr-name">CON</span>
                            <input type="number" id="field-constitution" name="constitution" min="1" max="30" value="10" class="attr-value">
                            <span class="attr-modifier" id="mod-constitution">+0</span>
                        </div>
                        <div class="attribute-box" data-attr="intelligence">
                            <span class="attr-name">INT</span>
                            <input type="number" id="field-intelligence" name="intelligence" min="1" max="30" value="10" class="attr-value">
                            <span class="attr-modifier" id="mod-intelligence">+0</span>
                        </div>
                        <div class="attribute-box" data-attr="wisdom">
                            <span class="attr-name">SAB</span>
                            <input type="number" id="field-wisdom" name="wisdom" min="1" max="30" value="10" class="attr-value">
                            <span class="attr-modifier" id="mod-wisdom">+0</span>
                        </div>
                        <div class="attribute-box" data-attr="charisma">
                            <span class="attr-name">CAR</span>
                            <input type="number" id="field-charisma" name="charisma" min="1" max="30" value="10" class="attr-value">
                            <span class="attr-modifier" id="mod-charisma">+0</span>
                        </div>
                    </div>

                    <!-- Columna central: Stats de combate -->
                    <div class="combat-column">
                        <div class="combat-stats">
                            <div class="combat-box ac">
                                <span class="combat-label">CLASE DE ARMADURA</span>
                                <input type="number" id="field-armor_class" name="armor_class" value="10" class="combat-value">
                            </div>
                            <div class="combat-box initiative">
                                <span class="combat-label">INICIATIVA</span>
                                <input type="number" id="field-initiative_bonus" name="initiative_bonus" value="0" class="combat-value">
                            </div>
                            <div class="combat-box speed">
                                <span class="combat-label">VELOCIDAD</span>
                                <input type="number" id="field-speed" name="speed" value="30" class="combat-value">
                                <span class="unit">pies</span>
                            </div>
                        </div>

                        <!-- HP Box -->
                        <div class="hp-section">
                            <h4>PUNTOS DE GOLPE</h4>
                            <div class="hp-boxes">
                                <div class="hp-box">
                                    <label>M√°ximo</label>
                                    <input type="number" id="field-max_hp" name="max_hp" min="1" value="10">
                                </div>
                                <div class="hp-box current">
                                    <label>Actuales</label>
                                    <input type="number" id="field-hp" name="hp" min="0" value="10">
                                </div>
                                <div class="hp-box temp">
                                    <label>Temp</label>
                                    <input type="number" id="field-temp_hp" name="temp_hp" min="0" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- Dados de golpe -->
                        <div class="hit-dice-section">
                            <label>Dados de Golpe</label>
                            <input type="text" id="field-hit_dice" name="hit_dice" value="1d8" placeholder="1d8">
                        </div>
                    </div>
                </div>

                <!-- Tiradas de salvaci√≥n -->
                <div class="sheet-section saving-throws">
                    <h3 class="section-title">TIRADAS DE SALVACI√ìN</h3>
                    <div class="saves-grid">
                        <label class="save-item"><input type="checkbox" name="saving_throws" value="Fuerza"> FUE</label>
                        <label class="save-item"><input type="checkbox" name="saving_throws" value="Destreza"> DES</label>
                        <label class="save-item"><input type="checkbox" name="saving_throws" value="Constituci√≥n"> CON</label>
                        <label class="save-item"><input type="checkbox" name="saving_throws" value="Inteligencia"> INT</label>
                        <label class="save-item"><input type="checkbox" name="saving_throws" value="Sabidur√≠a"> SAB</label>
                        <label class="save-item"><input type="checkbox" name="saving_throws" value="Carisma"> CAR</label>
                    </div>
                </div>

                <!-- Habilidades (Skills) - Contra√≠do por defecto -->
                <details class="sheet-section skills-section">
                    <summary class="section-title">COMPETENCIAS EN HABILIDADES</summary>
                    <div class="skills-grid">
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Acrobacias"> Acrobacias (DES)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Arcanos"> Arcanos (INT)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Atletismo"> Atletismo (FUE)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Enga√±o"> Enga√±o (CAR)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Historia"> Historia (INT)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Interpretaci√≥n"> Interpretaci√≥n (CAR)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Intimidaci√≥n"> Intimidaci√≥n (CAR)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Investigaci√≥n"> Investigaci√≥n (INT)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Juego de manos"> Juego de manos (DES)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Medicina"> Medicina (SAB)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Naturaleza"> Naturaleza (INT)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Percepci√≥n"> Percepci√≥n (SAB)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Perspicacia"> Perspicacia (SAB)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Persuasi√≥n"> Persuasi√≥n (CAR)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Religi√≥n"> Religi√≥n (INT)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Sigilo"> Sigilo (DES)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Supervivencia"> Supervivencia (SAB)</label>
                        <label class="skill-item"><input type="checkbox" name="skill_proficiencies" value="Trato con animales"> Trato con animales (SAB)</label>
                    </div>
                </details>

                <!-- Equipo -->
                <details class="sheet-section equipment-section">
                    <summary class="section-title">EQUIPO</summary>
                    <div class="equipment-content">
                        <div class="field-box">
                            <input type="text" id="field-armor" name="armor" placeholder=" ">
                            <label>Armadura</label>
                        </div>
                        <div class="field-box">
                            <textarea id="field-inventory" name="inventory" rows="3" placeholder="Escribe tu equipo aqu√≠..."></textarea>
                            <label>Inventario</label>
                        </div>
                        <div class="field-box small">
                            <input type="number" id="field-gold" name="gold" value="0" min="0">
                            <label>Oro (PO)</label>
                        </div>
                    </div>
                </details>

                <!-- Conjuros (solo para clases m√°gicas) -->
                <details class="sheet-section spells-section" id="spells-section">
                    <summary class="section-title">üîÆ CONJUROS</summary>
                    <div class="spells-content">
                        <div class="spell-stats">
                            <div class="field-box small">
                                <select id="field-spellcasting_ability" name="spellcasting_ability">
                                    <option value="">-</option>
                                    <option value="Inteligencia">INT</option>
                                    <option value="Sabidur√≠a">SAB</option>
                                    <option value="Carisma">CAR</option>
                                </select>
                                <label>Aptitud</label>
                            </div>
                            <div class="field-box small">
                                <input type="number" id="field-spell_save_dc" name="spell_save_dc" value="10">
                                <label>CD Salvaci√≥n</label>
                            </div>
                            <div class="field-box small">
                                <input type="number" id="field-spell_attack_bonus" name="spell_attack_bonus" value="0">
                                <label>Ataque</label>
                            </div>
                        </div>
                        <div class="field-box">
                            <textarea id="field-cantrips" name="cantrips" rows="2" placeholder="Trucos..."></textarea>
                            <label>Trucos</label>
                        </div>
                        <div class="field-box">
                            <textarea id="field-spells_known" name="spells_known" rows="4" placeholder="Conjuros conocidos..."></textarea>
                            <label>Conjuros</label>
                        </div>
                    </div>
                </details>

                <!-- Rasgos y caracter√≠sticas -->
                <details class="sheet-section features-section">
                    <summary class="section-title">RASGOS Y CARACTER√çSTICAS</summary>
                    <div class="features-content">
                        <div class="field-box">
                            <textarea id="field-racial_traits" name="racial_traits" rows="2" placeholder="Rasgos de tu raza..."></textarea>
                            <label>Rasgos Raciales</label>
                        </div>
                        <div class="field-box">
                            <textarea id="field-class_features" name="class_features" rows="2" placeholder="Rasgos de tu clase..."></textarea>
                            <label>Rasgos de Clase</label>
                        </div>
                        <div class="field-box">
                            <textarea id="field-feats" name="feats" rows="2" placeholder="Dotes..."></textarea>
                            <label>Dotes</label>
                        </div>
                    </div>
                </details>

                <!-- Personalidad -->
                <details class="sheet-section personality-section">
                    <summary class="section-title">PERSONALIDAD E HISTORIA</summary>
                    <div class="personality-content">
                        <div class="field-box">
                            <textarea id="field-personality_traits" name="personality_traits" rows="2" placeholder="Describe tu personalidad..."></textarea>
                            <label>Rasgos de Personalidad</label>
                        </div>
                        <div class="personality-grid">
                            <div class="field-box">
                                <textarea id="field-ideals" name="ideals" rows="2" placeholder="Tus ideales..."></textarea>
                                <label>Ideales</label>
                            </div>
                            <div class="field-box">
                                <textarea id="field-bonds" name="bonds" rows="2" placeholder="Tus v√≠nculos..."></textarea>
                                <label>V√≠nculos</label>
                            </div>
                        </div>
                        <div class="field-box">
                            <textarea id="field-flaws" name="flaws" rows="2" placeholder="Tus defectos..."></textarea>
                            <label>Defectos</label>
                        </div>
                        <div class="field-box">
                            <textarea id="field-backstory" name="backstory" rows="4" placeholder="Tu historia de fondo..."></textarea>
                            <label>Historia</label>
                        </div>
                    </div>
                </details>

                <!-- ============================================
                     BATTLETECH MECH RECORD SHEET
                     ============================================ -->
                <div id="battletech-sheet" class="bt-sheet hidden">
                    <!-- Header -->
                    <div class="bt-header">
                        <div class="bt-logo">ü§ñ</div>
                        <h1 class="bt-title">MECH RECORD SHEET</h1>
                    </div>

                    <!-- Pilot & Mech Info -->
                    <div class="bt-info-row">
                        <div class="bt-field-group">
                            <div class="bt-field wide">
                                <input type="text" id="bt-name" name="name" required placeholder=" ">
                                <label>PILOT NAME</label>
                            </div>
                            <div class="bt-field">
                                <input type="text" id="bt-callsign" name="callsign" placeholder=" ">
                                <label>CALLSIGN</label>
                            </div>
                        </div>
                        <div class="bt-field-group">
                            <div class="bt-field wide">
                                <input type="text" id="bt-mech_model" name="mech_model" required placeholder=" ">
                                <label>MECH MODEL</label>
                            </div>
                            <div class="bt-field">
                                <input type="text" id="bt-mech_variant" name="mech_variant" placeholder=" ">
                                <label>VARIANT</label>
                            </div>
                        </div>
                    </div>

                    <!-- Tonnage & Tech Base -->
                    <div class="bt-stats-row">
                        <div class="bt-stat-box">
                            <span class="stat-label">TONNAGE</span>
                            <input type="number" id="bt-tonnage" name="tonnage" min="20" max="100" value="50">
                        </div>
                        <div class="bt-stat-box">
                            <span class="stat-label">TECH BASE</span>
                            <select id="bt-tech_base" name="tech_base">
                                <option value="Inner Sphere">Inner Sphere</option>
                                <option value="Clan">Clan</option>
                                <option value="Mixed">Mixed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Pilot Skills -->
                    <div class="bt-pilot-section">
                        <h3 class="bt-section-title">PILOT SKILLS</h3>
                        <div class="bt-pilot-stats">
                            <div class="bt-pilot-stat">
                                <span class="pilot-stat-label">GUNNERY</span>
                                <div class="pilot-stat-circles">
                                    <input type="number" id="bt-gunnery" name="gunnery" min="0" max="8" value="4">
                                </div>
                            </div>
                            <div class="bt-pilot-stat">
                                <span class="pilot-stat-label">PILOTING</span>
                                <div class="pilot-stat-circles">
                                    <input type="number" id="bt-piloting" name="piloting" min="0" max="8" value="5">
                                </div>
                            </div>
                            <div class="bt-pilot-stat edge">
                                <span class="pilot-stat-label">EDGE</span>
                                <input type="number" id="bt-edge" name="edge" min="0" value="0">
                            </div>
                        </div>
                    </div>

                    <!-- Movement -->
                    <div class="bt-movement-section">
                        <h3 class="bt-section-title">MOVEMENT POINTS</h3>
                        <div class="bt-movement-stats">
                            <div class="bt-move-box walk">
                                <span class="move-icon">üö∂</span>
                                <span class="move-label">WALK</span>
                                <input type="number" id="bt-walk_mp" name="walk_mp" min="0" value="4">
                            </div>
                            <div class="bt-move-box run">
                                <span class="move-icon">üèÉ</span>
                                <span class="move-label">RUN</span>
                                <input type="number" id="bt-run_mp" name="run_mp" min="0" value="6">
                            </div>
                            <div class="bt-move-box jump">
                                <span class="move-icon">‚¨ÜÔ∏è</span>
                                <span class="move-label">JUMP</span>
                                <input type="number" id="bt-jump_mp" name="jump_mp" min="0" value="0">
                            </div>
                        </div>
                    </div>

                    <!-- Mech Diagram with Armor -->
                    <div class="bt-armor-section">
                        <h3 class="bt-section-title">ARMOR DIAGRAM</h3>
                        <div class="bt-mech-diagram">
                            <!-- Head -->
                            <div class="mech-part head">
                                <span class="part-name">HD</span>
                                <input type="number" id="bt-armor_head" name="armor_head" min="0" value="9" class="armor-input">
                                <input type="number" id="bt-internal_head" name="internal_head" min="0" value="3" class="internal-input">
                            </div>
                            
                            <!-- Arms Row -->
                            <div class="mech-arms-row">
                                <div class="mech-part arm left">
                                    <span class="part-name">LA</span>
                                    <input type="number" id="bt-armor_la" name="armor_la" min="0" value="16" class="armor-input">
                                    <input type="number" id="bt-internal_la" name="internal_la" min="0" value="10" class="internal-input">
                                </div>
                                
                                <!-- Torso Group -->
                                <div class="mech-torso-group">
                                    <div class="torso-row">
                                        <div class="mech-part torso side left">
                                            <span class="part-name">LT</span>
                                            <input type="number" id="bt-armor_lt" name="armor_lt" min="0" value="20" class="armor-input">
                                            <input type="number" id="bt-internal_lt" name="internal_lt" min="0" value="14" class="internal-input">
                                            <div class="rear-armor">
                                                <span>R:</span>
                                                <input type="number" id="bt-armor_lt_rear" name="armor_lt_rear" min="0" value="6">
                                            </div>
                                        </div>
                                        <div class="mech-part torso center">
                                            <span class="part-name">CT</span>
                                            <input type="number" id="bt-armor_ct" name="armor_ct" min="0" value="30" class="armor-input">
                                            <input type="number" id="bt-internal_ct" name="internal_ct" min="0" value="21" class="internal-input">
                                            <div class="rear-armor">
                                                <span>R:</span>
                                                <input type="number" id="bt-armor_ct_rear" name="armor_ct_rear" min="0" value="10">
                                            </div>
                                        </div>
                                        <div class="mech-part torso side right">
                                            <span class="part-name">RT</span>
                                            <input type="number" id="bt-armor_rt" name="armor_rt" min="0" value="20" class="armor-input">
                                            <input type="number" id="bt-internal_rt" name="internal_rt" min="0" value="14" class="internal-input">
                                            <div class="rear-armor">
                                                <span>R:</span>
                                                <input type="number" id="bt-armor_rt_rear" name="armor_rt_rear" min="0" value="6">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mech-part arm right">
                                    <span class="part-name">RA</span>
                                    <input type="number" id="bt-armor_ra" name="armor_ra" min="0" value="16" class="armor-input">
                                    <input type="number" id="bt-internal_ra" name="internal_ra" min="0" value="10" class="internal-input">
                                </div>
                            </div>
                            
                            <!-- Legs Row -->
                            <div class="mech-legs-row">
                                <div class="mech-part leg left">
                                    <span class="part-name">LL</span>
                                    <input type="number" id="bt-armor_ll" name="armor_ll" min="0" value="20" class="armor-input">
                                    <input type="number" id="bt-internal_ll" name="internal_ll" min="0" value="14" class="internal-input">
                                </div>
                                <div class="mech-part leg right">
                                    <span class="part-name">RL</span>
                                    <input type="number" id="bt-armor_rl" name="armor_rl" min="0" value="20" class="armor-input">
                                    <input type="number" id="bt-internal_rl" name="internal_rl" min="0" value="14" class="internal-input">
                                </div>
                            </div>
                        </div>
                        
                        <div class="bt-armor-legend">
                            <span class="legend-item"><span class="armor-color"></span> Armor</span>
                            <span class="legend-item"><span class="internal-color"></span> Internal</span>
                        </div>
                    </div>

                    <!-- Heat Management -->
                    <div class="bt-heat-section">
                        <h3 class="bt-section-title">HEAT MANAGEMENT</h3>
                        <div class="bt-heat-controls">
                            <div class="heat-stat">
                                <label>HEAT SINKS</label>
                                <input type="number" id="bt-heat_sinks" name="heat_sinks" min="0" value="10">
                            </div>
                            <div class="heat-stat">
                                <label>TYPE</label>
                                <select id="bt-heat_sink_type" name="heat_sink_type">
                                    <option value="Single">Single</option>
                                    <option value="Double">Double</option>
                                </select>
                            </div>
                            <div class="heat-stat current">
                                <label>CURRENT</label>
                                <input type="number" id="bt-current_heat" name="current_heat" min="0" value="0">
                            </div>
                        </div>
                        <div class="bt-heat-scale">
                            <div class="heat-bar">
                                <span class="heat-zone safe">0-4</span>
                                <span class="heat-zone warning">5-9</span>
                                <span class="heat-zone danger">10-14</span>
                                <span class="heat-zone critical">15+</span>
                            </div>
                        </div>
                    </div>

                    <!-- Weapons -->
                    <details class="bt-section weapons-section" open>
                        <summary class="bt-section-title">‚öîÔ∏è WEAPONS</summary>
                        <div class="bt-weapons-content">
                            <div id="bt-weapons-list" class="weapons-list">
                                <div class="weapon-row header">
                                    <span>WEAPON</span>
                                    <span>LOC</span>
                                    <span>DMG</span>
                                    <span>HEAT</span>
                                    <span>RNG</span>
                                </div>
                                <!-- Weapon entries will be added dynamically -->
                            </div>
                            <button type="button" id="btn-add-weapon" class="btn btn-sm btn-add">+ Add Weapon</button>
                            <textarea id="bt-weapons_text" name="weapons_text" rows="3" placeholder="Lista de armas (alternativo)..." class="weapons-textarea"></textarea>
                        </div>
                    </details>

                    <!-- Ammo -->
                    <details class="bt-section ammo-section">
                        <summary class="bt-section-title">üì¶ AMMUNITION</summary>
                        <div class="bt-ammo-content">
                            <textarea id="bt-ammo_text" name="ammo_text" rows="3" placeholder="AC/20 (CT): 5 rounds&#10;LRM-15 (LT): 16 rounds"></textarea>
                        </div>
                    </details>

                    <!-- Critical Hits -->
                    <details class="bt-section crits-section">
                        <summary class="bt-section-title">üí• CRITICAL HITS</summary>
                        <div class="bt-crits-content">
                            <textarea id="bt-critical_hits" name="critical_hits" rows="3" placeholder="Registra da√±os cr√≠ticos aqu√≠..."></textarea>
                        </div>
                    </details>

                    <!-- Notes -->
                    <details class="bt-section notes-section">
                        <summary class="bt-section-title">üìù NOTES</summary>
                        <div class="bt-notes-content">
                            <textarea id="bt-notes" name="notes" rows="4" placeholder="Notas adicionales, equipo especial, historia del piloto..."></textarea>
                        </div>
                    </details>
                </div>

                <!-- Container para campos din√°micos de otros sistemas -->
                <div id="form-fields-container" class="hidden"></div>
                
                <!-- Acciones del formulario -->
                <div class="sheet-actions">
                    <button type="button" id="btn-form-save" class="btn btn-secondary">üíæ Guardar Borrador</button>
                    <button type="submit" id="btn-form-submit" class="btn btn-success btn-large">üì§ Enviar al GM</button>
                </div>
            </form>
        </section>

        <!-- Pantalla: Escanear Ficha -->
        <section id="scan-screen" class="screen">
            <header class="mobile-header">
                <button id="btn-back-from-scan" class="btn-icon">‚Üê</button>
                <h2>Escanear Ficha</h2>
            </header>

            <div class="scan-container">
                <div class="camera-preview">
                    <video id="camera-video" autoplay playsinline></video>
                    <canvas id="camera-canvas" class="hidden"></canvas>
                    <div class="scan-overlay">
                        <div class="scan-frame"></div>
                    </div>
                </div>

                <div class="scan-instructions">
                    <p>üì∏ Coloca la ficha de personaje dentro del marco</p>
                    <p class="hint">Aseg√∫rate de que haya buena iluminaci√≥n</p>
                </div>

                <div class="scan-actions">
                    <button id="btn-capture" class="btn btn-primary btn-large">üì∑ Capturar</button>
                </div>

                <!-- Resultado del escaneo -->
                <div id="scan-result" class="scan-result hidden">
                    <img id="captured-image" src="" alt="Imagen capturada">
                    <div class="scan-result-actions">
                        <button id="btn-retry-scan" class="btn btn-secondary">üîÑ Reintentar</button>
                        <button id="btn-process-scan" class="btn btn-primary">‚ú® Procesar</button>
                    </div>
                </div>

                <!-- Procesando -->
                <div id="scan-processing" class="processing hidden">
                    <div class="spinner"></div>
                    <p>Analizando ficha con IA...</p>
                </div>
            </div>
        </section>
        
        <!-- Pantalla de Selecci√≥n de Personaje (legacy - para personajes ya creados) -->
        <section id="select-screen" class="screen">
            <header>
                <h2>Selecciona tu Personaje</h2>
                <span id="player-display-name"></span>
            </header>
            
            <div id="character-list" class="character-grid">
                <p class="empty-message">Esperando personajes...</p>
            </div>
            
            <div id="waiting-message" class="hidden">
                <p>üéØ Coloca tu figurita en la mesa</p>
            </div>
        </section>
        
        <!-- Pantalla Principal de Control -->
        <section id="control-screen" class="screen">
            <header>
                <div class="char-mini-info">
                    <div class="char-avatar" id="control-avatar">?</div>
                    <div>
                        <h2 id="control-char-name">-</h2>
                        <p id="control-char-class">-</p>
                    </div>
                </div>
                <button id="btn-leave" class="btn-icon">‚úï</button>
            </header>
            
            <!-- Stats -->
            <div class="stats-panel">
                <div class="stat hp">
                    <span class="label">‚ù§Ô∏è HP</span>
                    <div class="bar-container">
                        <div id="control-hp-bar" class="bar-fill"></div>
                    </div>
                    <span id="control-hp-text" class="value">-/-</span>
                </div>
                <div class="stat mana">
                    <span class="label">üíß MP</span>
                    <div class="bar-container">
                        <div id="control-mana-bar" class="bar-fill"></div>
                    </div>
                    <span id="control-mana-text" class="value">-/-</span>
                </div>
            </div>
            
            <!-- Indicador de turno -->
            <div id="turn-status" class="turn-status hidden">
                <span>‚öîÔ∏è ¬°Tu turno!</span>
            </div>
            
            <!-- Habilidades -->
            <div class="abilities-section">
                <h3>Habilidades</h3>
                <div id="abilities-list" class="abilities-grid">
                    <p class="empty-message">Sin habilidades</p>
                </div>
            </div>
            
            <!-- Acciones r√°pidas -->
            <div class="quick-actions">
                <button id="btn-attack" class="btn btn-action">
                    <span class="icon">‚öîÔ∏è</span>
                    <span>Atacar</span>
                </button>
                <button id="btn-defend" class="btn btn-action">
                    <span class="icon">üõ°Ô∏è</span>
                    <span>Defender</span>
                </button>
                <button id="btn-end-turn" class="btn btn-action">
                    <span class="icon">‚è≠Ô∏è</span>
                    <span>Fin Turno</span>
                </button>
            </div>
            
            <!-- Log de acciones -->
            <div class="action-log-mini">
                <div id="mobile-log"></div>
            </div>
        </section>
        
        <!-- Modal de selecci√≥n de objetivo -->
        <div id="target-modal" class="modal hidden">
            <div class="modal-content">
                <h3>Selecciona Objetivo</h3>
                <div id="target-list" class="target-grid"></div>
                <button id="btn-cancel-target" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
        
        <!-- Toast notifications -->
        <div id="toast-container"></div>
    </div>
    
    <script src="/mobile/js/app.js"></script>
    <script src="/mobile/js/controls.js"></script>
    <script src="/mobile/js/sheets.js"></script>
    
    <!-- Service Worker para PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/mobile/sw.js')
                .then(reg => console.log('SW registrado'))
                .catch(err => console.log('Error SW:', err));
        }
    </script>
</body>
</html>
