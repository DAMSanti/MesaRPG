<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>MesaRPG - Control</title>
    
    <link rel="manifest" href="/mobile/manifest.json">
    <link rel="icon" type="image/png" href="/mobile/assets/icon-192.png">
    <link rel="apple-touch-icon" href="/mobile/assets/icon-192.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/mobile/css/mobile.css">
</head>
<body>
    <div id="app">
        <!-- Pantalla de Login -->
        <section id="login-screen" class="screen active">
            <div class="login-container">
                <h1>ğŸ² MesaRPG</h1>
                <p>Control de Jugador</p>
                
                <form id="login-form">
                    <input type="text" id="player-name" placeholder="Tu nombre" required maxlength="20">
                    <button type="submit" class="btn btn-primary">Entrar</button>
                </form>
                
                <div id="connection-error" class="error hidden">
                    No se pudo conectar al servidor
                </div>
            </div>
        </section>

        <!-- Pantalla: Esperando Sistema de Juego -->
        <section id="waiting-system-screen" class="screen">
            <div class="centered-content">
                <div class="spinner"></div>
                <h2>Esperando al Game Master</h2>
                <p>El GM debe seleccionar un sistema de juego</p>
                <p id="player-welcome" class="welcome-text"></p>
            </div>
        </section>

        <!-- Pantalla: Estado de Ficha -->
        <section id="sheet-status-screen" class="screen">
            <header class="mobile-header">
                <h2>ğŸ“‹ Tu Ficha</h2>
                <span id="sheet-game-system" class="badge"></span>
            </header>

            <div class="sheet-status-container">
                <!-- Sin ficha -->
                <div id="no-sheet-panel" class="status-panel">
                    <div class="status-icon">ğŸ“</div>
                    <h3>Crea tu Personaje</h3>
                    <p>Elige cÃ³mo quieres crear tu ficha:</p>
                    
                    <div class="sheet-options">
                        <button id="btn-create-manual" class="btn btn-large btn-primary">
                            <span class="btn-icon">âœï¸</span>
                            <span class="btn-text">Rellenar Formulario</span>
                        </button>
                        
                        <button id="btn-scan-sheet" class="btn btn-large btn-secondary">
                            <span class="btn-icon">ğŸ“·</span>
                            <span class="btn-text">Escanear Ficha</span>
                        </button>
                        
                        <a id="btn-download-pdf" class="btn btn-large btn-outline" href="#" download>
                            <span class="btn-icon">ğŸ“„</span>
                            <span class="btn-text">Descargar PDF</span>
                        </a>
                    </div>
                </div>

                <!-- Ficha en borrador -->
                <div id="draft-sheet-panel" class="status-panel hidden">
                    <div class="status-icon">ğŸ“</div>
                    <h3>Ficha en Borrador</h3>
                    <p id="draft-char-name" class="char-name-display"></p>
                    <div class="action-buttons">
                        <button id="btn-edit-sheet" class="btn btn-primary">âœï¸ Editar</button>
                        <button id="btn-submit-sheet" class="btn btn-success">ğŸ“¤ Enviar al GM</button>
                    </div>
                </div>

                <!-- Ficha pendiente -->
                <div id="pending-sheet-panel" class="status-panel hidden">
                    <div class="status-icon pending">â³</div>
                    <h3>Pendiente de AprobaciÃ³n</h3>
                    <p id="pending-char-name" class="char-name-display"></p>
                    <p class="status-message">El Game Master estÃ¡ revisando tu ficha...</p>
                </div>

                <!-- Ficha rechazada -->
                <div id="rejected-sheet-panel" class="status-panel hidden">
                    <div class="status-icon rejected">âŒ</div>
                    <h3>Ficha Rechazada</h3>
                    <p id="rejected-char-name" class="char-name-display"></p>
                    <p id="rejection-reason" class="rejection-reason"></p>
                    <button id="btn-fix-sheet" class="btn btn-primary">âœï¸ Corregir y Reenviar</button>
                </div>

                <!-- Ficha aprobada, esperando token -->
                <div id="approved-sheet-panel" class="status-panel hidden">
                    <div class="status-icon approved">âœ…</div>
                    <h3>Â¡Ficha Aprobada!</h3>
                    <p id="approved-char-name" class="char-name-display"></p>
                    <p class="status-message">Esperando que el GM te asigne un token...</p>
                </div>

                <!-- En juego -->
                <div id="ingame-sheet-panel" class="status-panel hidden">
                    <div class="status-icon ingame">ğŸ®</div>
                    <h3>Â¡En Juego!</h3>
                    <p id="ingame-char-name" class="char-name-display"></p>
                    <p class="status-message">Token asignado: <span id="assigned-token">#</span></p>
                    <button id="btn-go-control" class="btn btn-primary btn-large">âš”ï¸ Ir al Control</button>
                </div>
            </div>
        </section>

        <!-- Pantalla: Formulario de Ficha -->
        <section id="sheet-form-screen" class="screen">
            <header class="mobile-header">
                <button id="btn-back-from-form" class="btn-icon">â†</button>
                <h2 id="form-title">Crear Personaje</h2>
                <button id="btn-save-draft" class="btn btn-sm">Guardar</button>
            </header>

            <form id="character-sheet-form" class="sheet-form">
                <!-- Los campos se generan dinÃ¡micamente segÃºn el sistema de juego -->
                <div id="form-fields-container"></div>
                
                <div class="form-actions">
                    <button type="button" id="btn-form-save" class="btn btn-secondary">ğŸ’¾ Guardar Borrador</button>
                    <button type="submit" id="btn-form-submit" class="btn btn-success">ğŸ“¤ Enviar al GM</button>
                </div>
            </form>
        </section>

        <!-- Pantalla: Escanear Ficha -->
        <section id="scan-screen" class="screen">
            <header class="mobile-header">
                <button id="btn-back-from-scan" class="btn-icon">â†</button>
                <h2>Escanear Ficha</h2>
            </header>

            <div class="scan-container">
                <div class="camera-preview">
                    <video id="camera-video" autoplay playsinline></video>
                    <canvas id="camera-canvas" class="hidden"></canvas>
                    <div class="scan-overlay">
                        <div class="scan-frame"></div>
                    </div>
                </div>

                <div class="scan-instructions">
                    <p>ğŸ“¸ Coloca la ficha de personaje dentro del marco</p>
                    <p class="hint">AsegÃºrate de que haya buena iluminaciÃ³n</p>
                </div>

                <div class="scan-actions">
                    <button id="btn-capture" class="btn btn-primary btn-large">ğŸ“· Capturar</button>
                </div>

                <!-- Resultado del escaneo -->
                <div id="scan-result" class="scan-result hidden">
                    <img id="captured-image" src="" alt="Imagen capturada">
                    <div class="scan-result-actions">
                        <button id="btn-retry-scan" class="btn btn-secondary">ğŸ”„ Reintentar</button>
                        <button id="btn-process-scan" class="btn btn-primary">âœ¨ Procesar</button>
                    </div>
                </div>

                <!-- Procesando -->
                <div id="scan-processing" class="processing hidden">
                    <div class="spinner"></div>
                    <p>Analizando ficha con IA...</p>
                </div>
            </div>
        </section>
        
        <!-- Pantalla de SelecciÃ³n de Personaje (legacy - para personajes ya creados) -->
        <section id="select-screen" class="screen">
            <header>
                <h2>Selecciona tu Personaje</h2>
                <span id="player-display-name"></span>
            </header>
            
            <div id="character-list" class="character-grid">
                <p class="empty-message">Esperando personajes...</p>
            </div>
            
            <div id="waiting-message" class="hidden">
                <p>ğŸ¯ Coloca tu figurita en la mesa</p>
            </div>
        </section>
        
        <!-- Pantalla Principal de Control -->
        <section id="control-screen" class="screen">
            <header>
                <div class="char-mini-info">
                    <div class="char-avatar" id="control-avatar">?</div>
                    <div>
                        <h2 id="control-char-name">-</h2>
                        <p id="control-char-class">-</p>
                    </div>
                </div>
                <button id="btn-leave" class="btn-icon">âœ•</button>
            </header>
            
            <!-- Stats -->
            <div class="stats-panel">
                <div class="stat hp">
                    <span class="label">â¤ï¸ HP</span>
                    <div class="bar-container">
                        <div id="control-hp-bar" class="bar-fill"></div>
                    </div>
                    <span id="control-hp-text" class="value">-/-</span>
                </div>
                <div class="stat mana">
                    <span class="label">ğŸ’§ MP</span>
                    <div class="bar-container">
                        <div id="control-mana-bar" class="bar-fill"></div>
                    </div>
                    <span id="control-mana-text" class="value">-/-</span>
                </div>
            </div>
            
            <!-- Indicador de turno -->
            <div id="turn-status" class="turn-status hidden">
                <span>âš”ï¸ Â¡Tu turno!</span>
            </div>
            
            <!-- Habilidades -->
            <div class="abilities-section">
                <h3>Habilidades</h3>
                <div id="abilities-list" class="abilities-grid">
                    <p class="empty-message">Sin habilidades</p>
                </div>
            </div>
            
            <!-- Acciones rÃ¡pidas -->
            <div class="quick-actions">
                <button id="btn-attack" class="btn btn-action">
                    <span class="icon">âš”ï¸</span>
                    <span>Atacar</span>
                </button>
                <button id="btn-defend" class="btn btn-action">
                    <span class="icon">ğŸ›¡ï¸</span>
                    <span>Defender</span>
                </button>
                <button id="btn-end-turn" class="btn btn-action">
                    <span class="icon">â­ï¸</span>
                    <span>Fin Turno</span>
                </button>
            </div>
            
            <!-- Log de acciones -->
            <div class="action-log-mini">
                <div id="mobile-log"></div>
            </div>
        </section>
        
        <!-- Modal de selecciÃ³n de objetivo -->
        <div id="target-modal" class="modal hidden">
            <div class="modal-content">
                <h3>Selecciona Objetivo</h3>
                <div id="target-list" class="target-grid"></div>
                <button id="btn-cancel-target" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
        
        <!-- Toast notifications -->
        <div id="toast-container"></div>
    </div>
    
    <script src="/mobile/js/app.js"></script>
    <script src="/mobile/js/controls.js"></script>
    <script src="/mobile/js/sheets.js"></script>
    
    <!-- Service Worker para PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/mobile/sw.js')
                .then(reg => console.log('SW registrado'))
                .catch(err => console.log('Error SW:', err));
        }
    </script>
</body>
</html>
